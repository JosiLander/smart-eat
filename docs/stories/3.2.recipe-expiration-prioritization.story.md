# Story 3.2: Recipe Suggestions with Expiration Prioritization

## Status
Ready for Review

## Story
**As a** Smart-Eat user,
**I want** recipe suggestions to prioritize ingredients that are expiring soonest,
**so that** I can reduce food waste by using items before they go bad

## Acceptance Criteria
1. Recipe suggestions algorithm prioritizes recipes using ingredients expiring within 3 days
2. Recipe match score calculation includes expiration date weighting
3. Recipe suggestions screen displays expiration priority indicators
4. Users can filter recipes by "Use Expiring Items" preference
5. Recipe suggestions show count of expiring ingredients used
6. Expiration priority is visually indicated with badges/indicators
7. Recipe search performance remains under 2 seconds
8. Existing recipe functionality continues to work unchanged
9. Recipe suggestions maintain backward compatibility
10. Expiration weighting is configurable and testable

## Tasks / Subtasks
- [x] Task 1: Enhance RecipeService scoring algorithm (AC: 1, 2, 9)
  - [x] Add expiration weight calculation method
  - [x] Integrate expiration weighting into match score calculation
  - [x] Update RecipeSuggestion interface to include expiration data
  - [x] Add unit tests for new scoring logic
- [x] Task 2: Update RecipeSuggestionsScreen UI (AC: 3, 4, 5, 6)
  - [x] Add expiration priority badges to recipe cards
  - [x] Create "Use Expiring Items" filter toggle
  - [x] Display expiration ingredient count
  - [x] Add visual indicators for high-priority recipes
- [x] Task 3: Implement expiration filtering (AC: 4, 7)
  - [x] Add expiration filter to RecipeSearchFilters interface
  - [x] Update getRecipeSuggestions method to handle expiration filter
  - [x] Optimize search performance with new filtering
  - [x] Add integration tests for filtering functionality
- [x] Task 4: Update RecipeService methods (AC: 8, 10)
  - [x] Enhance analyzeRecipeMatch method with expiration weighting
  - [x] Add getRecipesForExpiringItems method improvements
  - [x] Update existing recipe suggestion methods
  - [x] Add configuration options for expiration weighting

## Dev Notes

### Previous Story Insights
Based on Stories 1.1-1.3, 2.1-2.2, and 3.1, we have:
- Camera functionality for capturing photos
- AI recognition for identifying grocery items
- OCR date extraction for expiration dates
- Inventory dashboard with expiration tracking
- Basic recipe database and matching system
- Recipe suggestions screen with basic functionality

### Data Models
Based on the existing RecipeService.ts, this story will enhance:
- RecipeSuggestion interface: Add expirationPriority, expiringIngredientsCount
- RecipeSearchFilters interface: Add prioritizeExpiring boolean
- InventoryItem interface: Already has daysUntilExpiry and isExpired properties

### API Specifications
Based on the services architecture, this story will enhance:
- RecipeService.getRecipeSuggestions(): Add expiration prioritization
- RecipeService.analyzeRecipeMatch(): Add expiration weighting
- RecipeService.getRecipesForExpiringItems(): Improve existing method
- New method: calculateExpirationWeight()

### Component Specifications
Based on the system overview:
- RecipeSuggestionsScreen: Add expiration indicators and filters
- Recipe cards: Display expiration priority badges
- Filter controls: Add "Use Expiring Items" toggle
- Performance: Maintain sub-2-second search times

### File Locations
Based on the project structure:
- RecipeService.ts: smart-eat-app/services/RecipeService.ts
- RecipeSuggestionsScreen.tsx: smart-eat-app/components/RecipeSuggestionsScreen.tsx
- Recipe interfaces: smart-eat-app/services/RecipeService.ts
- Tests: smart-eat-app/services/__tests__/RecipeService.test.ts

### Testing Requirements
- Unit tests for expiration weight calculation
- Integration tests for recipe suggestion scoring
- UI tests for expiration indicators and filters
- Performance tests for enhanced search
- Regression tests for existing functionality

### Technical Constraints
- Cross-platform compatibility (iOS/Android)
- Fast search performance (under 2 seconds)
- Backward compatibility with existing recipe suggestions
- Configurable expiration weighting system
- Integration with existing inventory system

### Implementation Details

#### Enhanced Scoring Algorithm
```typescript
// Add to RecipeService.ts analyzeRecipeMatch method
private static calculateExpirationWeight(inventoryItem: InventoryItem): number {
  if (inventoryItem.isExpired) return 0;
  if (inventoryItem.daysUntilExpiry <= 1) return 2.0; // High priority
  if (inventoryItem.daysUntilExpiry <= 3) return 1.5; // Medium priority
  if (inventoryItem.daysUntilExpiry <= 7) return 1.2; // Low priority
  return 1.0; // Normal priority
}
```

#### Updated RecipeSuggestion Interface
```typescript
export interface RecipeSuggestion {
  recipe: Recipe;
  matchScore: number;
  missingIngredients: RecipeIngredient[];
  availableIngredients: RecipeIngredient[];
  canMakeWithSubstitutions: boolean;
  estimatedPrepTime: number;
  // New fields for expiration prioritization
  expirationPriority: number; // 0-1 score based on expiring ingredients
  expiringIngredientsCount: number; // Count of ingredients expiring soon
  expiringIngredients: RecipeIngredient[]; // List of expiring ingredients used
}
```

#### Enhanced RecipeSearchFilters
```typescript
export interface RecipeSearchFilters {
  maxPrepTime?: number;
  difficulty?: Recipe['difficulty'];
  cuisine?: string;
  tags?: string[];
  maxMissingIngredients?: number;
  // New field for expiration prioritization
  prioritizeExpiring?: boolean; // Whether to prioritize expiring items
}
```

### UI Enhancement Specifications
- **Expiration Badge**: Red/orange badge showing "Expires Soon" or "Use Today"
- **Priority Indicator**: Visual indicator (star/flag) for high-priority recipes
- **Filter Toggle**: Switch/toggle for "Use Expiring Items" filter
- **Ingredient Count**: Small badge showing "X expiring ingredients"
- **Color Coding**: Red for 1 day, orange for 2-3 days, yellow for 4-7 days

### Testing
- Test expiration weight calculation with various expiration dates
- Test recipe suggestion scoring with mixed expiration dates
- Test UI components with expiration indicators
- Test filter functionality for expiring items
- Test performance with large recipe database
- Test backward compatibility with existing features

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2024-01-XX | 1.0 | Initial story creation | Product Manager |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4 - Full Stack Developer Agent

### Debug Log References
- Enhanced RecipeService.ts with expiration prioritization logic
- Added calculateExpirationWeight() method for inventory item weighting
- Added calculateExpirationPriority() method for recipe scoring
- Updated RecipeSuggestion interface with expiration fields
- Updated RecipeSearchFilters interface with prioritizeExpiring option
- Enhanced analyzeRecipeMatch() method with expiration weighting
- Updated getRecipeSuggestions() method with enhanced sorting
- Updated passesFilters() method with expiration filtering
- Added comprehensive unit tests for new functionality

### Completion Notes List
- Task 1 completed successfully with all acceptance criteria met
- All 26 tests passing including new expiration prioritization tests
- Backward compatibility maintained - existing functionality unchanged
- Expiration weighting algorithm implemented with configurable boost (up to 30%)
- Recipe suggestions now include expirationPriority, expiringIngredientsCount, and expiringIngredients
- Enhanced sorting prioritizes expiration when filter is enabled
- Task 2 completed successfully with all UI enhancements implemented
- Added expiration priority badges with color-coded indicators (red/orange/yellow)
- Added "Use Expiring Items" filter toggle with visual feedback
- Added expiration ingredient count display
- Added visual indicators for high-priority recipes
- All existing functionality preserved and tests passing
- Task 3 completed successfully with comprehensive expiration filtering
- Added 5 new integration tests for expiration filtering functionality
- Performance tests confirm sub-2-second execution time
- Filtering correctly excludes recipes with no expiring ingredients
- Sorting prioritizes recipes by expiration priority
- Proper handling of expired items (excluded from priority calculation)
- All 30 tests passing including new integration tests
- Task 4 completed successfully with configurable expiration weighting
- Added configurable expiration threshold and weight multiplier options
- Enhanced RecipeSearchFilters interface with new configuration fields
- Added getExpirationConfig() method for accessing configuration options
- Updated getRecipesForExpiringItems() to support custom thresholds
- Added 4 new tests for configuration functionality
- All 34 tests passing including new configuration tests
- Complete feature implementation with full configurability and backward compatibility

### File List
- Modified: smart-eat-app/services/RecipeService.ts
- Modified: smart-eat-app/services/__tests__/RecipeService.test.ts
- Modified: smart-eat-app/components/RecipeSuggestionsScreen.tsx

## QA Results
[To be filled by QA Agent]
